// Donn√©es
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

// √âl√©ments du DOM
const incomeForm = document.getElementById('incomeForm');
const expenseForm = document.getElementById('expenseForm');
const transactionsList = document.getElementById('transactionsList');
const totalBalance = document.getElementById('totalBalance');
const totalIncome = document.getElementById('totalIncome');
const totalExpense = document.getElementById('totalExpense');
const filterType = document.getElementById('filterType');
const filterCategory = document.getElementById('filterCategory');
const clearAllBtn = document.getElementById('clearAll');

// Fonction d'initialisation
function init() {
    // D√©finir la date d'aujourd'hui par d√©faut
    const today = new Date().toISOString().split('T')[0];
    const incomeDateInput = document.getElementById('incomeDate');
    const expenseDateInput = document.getElementById('expenseDate');
    
    if (incomeDateInput) incomeDateInput.value = today;
    if (expenseDateInput) expenseDateInput.value = today;
    
    // Mettre √† jour l'interface
    updateUI();
}

// Ajouter un revenu
if (incomeForm) {
    incomeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('incomeAmount').value);
        const category = document.getElementById('incomeCategory').value;
        const description = document.getElementById('incomeDescription').value;
        const date = document.getElementById('incomeDate').value;
        
        if (!amount || !category || !description || !date) {
            alert('Veuillez remplir tous les champs');
            return;
        }
        
        const transaction = {
            id: Date.now(),
            type: 'income',
            amount: amount,
            category: category,
            description: description,
            date: date
        };
        
        transactions.push(transaction);
        saveTransactions();
        incomeForm.reset();
        document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
        updateUI();
        
        showNotification('‚úÖ Revenu ajout√© avec succ√®s !', 'success');
    });
}

// Ajouter une d√©pense
if (expenseForm) {
    expenseForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        const category = document.getElementById('expenseCategory').value;
        const description = document.getElementById('expenseDescription').value;
        const date = document.getElementById('expenseDate').value;
        
        if (!amount || !category || !description || !date) {
            alert('Veuillez remplir tous les champs');
            return;
        }
        
        const transaction = {
            id: Date.now(),
            type: 'expense',
            amount: amount,
            category: category,
            description: description,
            date: date
        };
        
        transactions.push(transaction);
        saveTransactions();
        expenseForm.reset();
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        updateUI();
        
        showNotification('‚úÖ D√©pense ajout√©e avec succ√®s !', 'success');
    });
}

// Sauvegarder dans localStorage
function saveTransactions() {
    localStorage.setItem('transactions', JSON.stringify(transactions));
}

// Mettre √† jour l'interface
function updateUI() {
    updateSummary();
    displayTransactions();
    updateCategoryFilter();
}

// Mettre √† jour le r√©sum√©
function updateSummary() {
    const income = transactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const expense = transactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const balance = income - expense;
    
    if (totalIncome) totalIncome.textContent = formatCurrency(income);
    if (totalExpense) totalExpense.textContent = formatCurrency(expense);
    if (totalBalance) totalBalance.textContent = formatCurrency(balance);
}

// Afficher les transactions
function displayTransactions() {
    if (!transactionsList) return;
    
    const typeFilter = filterType ? filterType.value : 'all';
    const categoryFilter = filterCategory ? filterCategory.value : 'all';
    
    let filtered = [...transactions];
    
    if (typeFilter !== 'all') {
        filtered = filtered.filter(t => t.type === typeFilter);
    }
    
    if (categoryFilter !== 'all') {
        filtered = filtered.filter(t => t.category === categoryFilter);
    }
    
    // Trier par date (plus r√©cent en premier)
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (filtered.length === 0) {
        transactionsList.innerHTML = `
            <div class="empty-state">
                <h3>üì≠ Aucune transaction</h3>
                <p>Commencez par ajouter vos revenus et d√©penses</p>
            </div>
        `;
        return;
    }
    
    transactionsList.innerHTML = filtered.map(transaction => `
        <div class="transaction-item ${transaction.type}">
            <div class="transaction-info">
                <h4>${transaction.category}</h4>
                <p>${transaction.description}</p>
                <p style="font-size: 0.85em; color: #999;">${formatDate(transaction.date)}</p>
            </div>
            <div class="transaction-amount">
                ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
            </div>
            <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">
                üóëÔ∏è
            </button>
        </div>
    `).join('');
}

// Supprimer une transaction
function deleteTransaction(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette transaction ?')) {
        transactions = transactions.filter(t => t.id !== id);
        saveTransactions();
        updateUI();
        showNotification('üóëÔ∏è Transaction supprim√©e', 'info');
    }
}

// Tout effacer
if (clearAllBtn) {
    clearAllBtn.addEventListener('click', function() {
        if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUTES les transactions ?\nCette action est irr√©versible !')) {
            transactions = [];
            saveTransactions();
            updateUI();
            showNotification('üóëÔ∏è Toutes les transactions ont √©t√© supprim√©es', 'info');
        }
    });
}

// Mettre √† jour le filtre des cat√©gories
function updateCategoryFilter() {
    if (!filterCategory) return;
    
    const categories = [...new Set(transactions.map(t => t.category))];
    
    filterCategory.innerHTML = '<option value="all">Toutes les cat√©gories</option>';
    categories.forEach(cat => {
        filterCategory.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
}

// Filtres
if (filterType) {
    filterType.addEventListener('change', displayTransactions);
}

if (filterCategory) {
    filterCategory.addEventListener('change', displayTransactions);
}

// Formater la monnaie
function formatCurrency(amount) {
    return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR'
    }).format(amount);
}

// Formater la date
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString('fr-FR', options);
}

// Notification
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#27ae60' : '#3498db'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        font-weight: bold;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(function() {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(function() {
            notification.remove();
        }, 300);
    }, 3000);
}

// Animations CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Initialiser quand la page est charg√©e
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
